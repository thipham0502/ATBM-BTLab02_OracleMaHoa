--Stored procedure giải mã lương của một nhân viên 
--với khóa ENCRYPT_KEY của nhân viên đó
CREATE OR REPLACE PROCEDURE sp_Decrypt_NHANVIEN_Luong_1612894(
  V_MANV VARCHAR2, 
  V_KEY RAW, --encryption key
  V_DECRYPTED_LUONG OUT VARCHAR2)
AS 
  V_EXISTS INT;
  V_DIENTHOAI CHAR(10);
  V_ENCRYPTED_LUONG RAW(2000);
  V_LUONG_XOR_RESULT RAW(2000);
  V_DECRYPTED_RAW RAW (2000); -- stores decrypted data
  V_ENCRYPTION_TYPE PLS_INTEGER := -- total encryption type
  DBMS_CRYPTO.ENCRYPT_AES256 + DBMS_CRYPTO.CHAIN_CBC + DBMS_CRYPTO.PAD_PKCS5;
BEGIN
  SELECT COUNT(*) INTO V_EXISTS 
  FROM NHANVIEN 
  WHERE MANV = V_MANV AND ENCRYPT_KEY = V_KEY;
  IF(V_EXISTS = 0) THEN
    V_DECRYPTED_LUONG := '';
  ELSE
    SELECT DIENTHOAI, ENCRYPTED_LUONG INTO V_DIENTHOAI, V_ENCRYPTED_LUONG
    FROM NHANVIEN
    WHERE MANV = V_MANV;
    
    -- V_DECRYPTED_RAW
    V_DECRYPTED_RAW := DBMS_CRYPTO.DECRYPT
    (
    src => V_ENCRYPTED_LUONG,
    typ => V_ENCRYPTION_TYPE,
    key => V_KEY
    );
    
    -- V_DECRYPTED_RAW = LUONG XOR DIENTHOAI ==> LUONG = V_DECRYPTED_RAW XOR DIENTHOAI
    V_LUONG_XOR_RESULT := UTL_RAW.BIT_XOR(V_DECRYPTED_RAW, UTL_RAW.CAST_TO_RAW(V_DIENTHOAI));

    V_DECRYPTED_LUONG := UTL_I18N.RAW_TO_CHAR (V_LUONG_XOR_RESULT, 'AL32UTF8');
  END IF;
END sp_Decrypt_NHANVIEN_Luong_1612894;
/
SET SERVEROUTPUT ON;
DECLARE DECRYPTED_LUONG VARCHAR2(10);
BEGIN
  sp_Decrypt_NHANVIEN_Luong_1612894('NV01', 'D01966ABA9C77997A9257D69B4BA182F300286AA7C4B88322CE2119F43BB3AEF', DECRYPTED_LUONG);
  DBMS_OUTPUT.PUT_LINE ('Decrypted salary: ' || DECRYPTED_LUONG);
END;
/